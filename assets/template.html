<html>

<head>
  <style>
    .table {
      display: table;
      table-layout: auto;
      width: auto;
    }

    .charts {
      display: table-cell;
      width: auto;
    }
  </style>
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <script type="text/javascript">
    google.charts.load('current', {'packages': ['corechart']})

    drawChart = () => {
      fetch("http://localhost:8080/resource")
        .then(res => {
          if (res.ok) {
            return res.text()
          } else {
            return Promise.reject(new Error('/resource Error.'));
          }
        })
        .then(body => filter(body).forEach(e => addChart(e))
        )
    }

    addChart = (source) => {
      var data = google.visualization.arrayToDataTable(source.sp_list);
      var options = {
        title: source.name,
        legend: {position: 'bottom'},
        vAxis: {maxValue: source.sp_max, minValue: 0},
      };

      const elm = document.createElement("div")
      elm.id = 'curve_chart_' + document.querySelectorAll("div[id^='curve_chart']").length
      elm.classList.add("charts")
      getAndCreateInsertTable().insertAdjacentElement('beforeend', elm)
      new google.visualization.LineChart(elm).draw(data, options)
    }

    getAndCreateInsertTable = () => {
      const tables = Array.from(document.querySelectorAll(".table")).filter(e => e.querySelectorAll(".charts").length < config.sideBySideLimit)
      if (tables.length) {
        return tables[0]
      }
      const res = document.createElement("div")
      res.classList.add("table")
      document.body.insertAdjacentElement('beforeend', res)
      return res
    }

    filter = (body) => {
      return JSON.parse(body).map(e => {
        return {
          name: e.name,
          sp_max: Math.max(e.list.map(elm => elm.sp)),
          sp_list: [
            ['day', 'param'],
          ].concat(e.list.map(elm => ["", elm.sp]))
        }
      })
    }

    const config = {
      sideBySideLimit: 3
    }

    google.charts.setOnLoadCallback(drawChart);
  </script>
</head>

<body>
</body>

</html>
